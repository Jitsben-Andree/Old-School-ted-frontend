<div class="container mx-auto p-4 sm:p-6">
  <h1 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-3">Asignar Productos a Proveedores</h1>

  <!-- 1. Estado de Carga Inicial -->
  @if (isLoading() && !selectedProductId()) {
    <div class="text-center p-10">
      <p class="text-lg text-gray-600 animate-pulse">Cargando productos y proveedores...</p>
    </div>
  }

  <!-- 2. Error de Carga Inicial -->
  @if (error() && !isLoading()) {
    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-md shadow" role="alert">
      <p class="font-bold">Error de Carga</p>
      <p>{{ error() }}</p>
    </div>
  }

  <!-- 3. Contenido Principal (Formulario y Tabla) -->
  @if (!isLoading() || selectedProductId()) { <!-- Mostrar contenido si no está cargando O si ya hay un producto seleccionado -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

      <!-- Columna Izquierda: Formulario -->
      <div class="md:col-span-1 bg-white p-6 rounded-lg shadow-md h-fit">
        <h2 class="text-xl font-semibold mb-4 text-gray-700">
          {{ editMode() ? 'Editar Precio de Costo' : 'Nueva Asignación' }}
        </h2>
        <form [formGroup]="asignacionForm" (ngSubmit)="onSubmit()">
          <!-- Selector de Producto -->
          <div class="mb-4">
            <label for="productoId" class="block text-sm font-medium text-gray-700 mb-1">Producto</label>
            <select id="productoId" formControlName="productoId"
                    class="w-full rounded-md border border-gray-300 bg-white py-2 px-3 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 disabled:bg-gray-100">
              <option value="" disabled>-- Seleccione Producto --</option>
              <!-- Usar trackProdById -->
              @for (prod of productos(); track trackProdById($index, prod)) {
                <option [value]="prod.id">{{ prod.nombre }}</option>
              }
            </select>
            @if (asignacionForm.get('productoId')?.invalid && asignacionForm.get('productoId')?.touched) {
              <p class="text-red-500 text-xs mt-1">Seleccione un producto.</p>
            }
          </div>

          <!-- Selector de Proveedor -->
          <div class="mb-4">
            <label for="proveedorId" class="block text-sm font-medium text-gray-700 mb-1">Proveedor</label>
            <select id="proveedorId" formControlName="proveedorId"
                    class="w-full rounded-md border border-gray-300 bg-white py-2 px-3 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-indigo-500 disabled:bg-gray-100">
              <option value="" disabled>-- Seleccione Proveedor --</option>
               <!-- Usar trackProvById -->
               @for (prov of proveedores(); track trackProvById($index, prov)) {
                <option [value]="prov.idProveedor">{{ prov.razonSocial }}</option>
              }
            </select>
             @if (asignacionForm.get('proveedorId')?.invalid && asignacionForm.get('proveedorId')?.touched) {
              <p class="text-red-500 text-xs mt-1">Seleccione un proveedor.</p>
            }
          </div>

          <!-- Precio de Costo -->
          <div class="mb-4">
            <label for="precioCosto" class="block text-sm font-medium text-gray-700 mb-1">Precio de Costo (S/)</label>
            <input type="number" id="precioCosto" formControlName="precioCosto" step="0.01"
                   class="w-full rounded-md border border-gray-300 py-2 px-3 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-indigo-500" />
            @if (asignacionForm.get('precioCosto')?.invalid && asignacionForm.get('precioCosto')?.touched) {
              <p class="text-red-500 text-xs mt-1">
                @if (asignacionForm.get('precioCosto')?.errors?.['required']) { <span>El precio es requerido.</span> }
                @if (asignacionForm.get('precioCosto')?.errors?.['min']) { <span>El precio debe ser mayor a 0.</span> }
              </p>
            }
          </div>

          <!-- Error del Formulario -->
          @if(formError()) {
             <p class="text-red-600 text-sm mb-3">{{ formError() }}</p>
          }

          <!-- Botones -->
          <div class="flex items-center space-x-3">
            <button type="submit" [disabled]="asignacionForm.invalid || isLoading()"
                    class="flex-1 justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:bg-gray-400">
               @if (isLoading() && editMode()) {
                 <span>Actualizando...</span>
               } @else if (isLoading() && !editMode()) {
                  <span>Guardando...</span>
               } @else if (editMode()) {
                  <span>Actualizar Precio</span>
               } @else {
                  <span>Guardar Asignación</span>
               }
            </button>
            @if(editMode()) {
              <button type="button" (click)="resetForm()"
                      class="rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                Cancelar
              </button>
            }
          </div>
        </form>
      </div>

      <!-- Columna Derecha: Tabla de Asignaciones -->
      <div class="md:col-span-2">
        <!-- Usar @if con alias y mostrar el título usando el computed signal -->
        @if (selectedProductId(); as prodId) {
          <h2 class="text-xl font-semibold mb-4 text-gray-700">
            Proveedores para:
            <span class="text-indigo-600">
              <!-- *** ESTA ES LA LÍNEA CORREGIDA *** -->
              {{ selectedProductName() }}
            </span>
          </h2>

          <!-- Mostrar loading específico de tabla -->
          @if (isLoading() && asignaciones().length === 0) {
              <p class="text-gray-500 animate-pulse">Cargando asignaciones...</p>
          } @else if (!isLoading() && asignaciones().length === 0) {
              <p class="text-gray-500">Este producto aún no tiene proveedores asignados.</p>
          } @else if (asignaciones().length > 0) {
            <div class="overflow-x-auto bg-white rounded-lg shadow">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proveedor</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio Costo</th>
                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                   <!-- Usar trackAsigById -->
                   @for (asig of asignaciones(); track trackAsigById($index, asig)) {
                    <tr class="hover:bg-gray-50">
                      <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">{{ asig.proveedorRazonSocial }}</td>
                      <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{{ asig.precioCosto | currency:'S/ ' }}</td>
                      <td class="px-4 py-3 whitespace-nowrap text-sm font-medium space-x-2">
                        <button (click)="onEdit(asig)" class="text-indigo-600 hover:text-indigo-900">Editar Precio</button>
                        <button (click)="onDelete(asig.idAsignacion, asig.proveedorRazonSocial)" class="text-red-600 hover:text-red-900">Eliminar</button>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        } @else {
          <p class="text-gray-500 mt-6">Seleccione un producto para ver sus proveedores asignados.</p>
        } <!-- Fin del @if selectedProductId -->
      </div> <!-- Fin Columna Derecha -->
    </div>
  } <!-- Fin @if !isLoading -->
</div>

