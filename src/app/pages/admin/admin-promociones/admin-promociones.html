<div class="container mx-auto p-4 sm:p-6">
  <h1 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-3">Gestionar Promociones</h1>

  <!-- Formulario para Crear/Editar -->
  <div class="bg-white p-6 rounded-lg shadow-md mb-8">
    <h2 class="text-xl font-semibold mb-4 text-gray-700">
      {{ editMode() ? 'Editar Promoción' : 'Crear Nueva Promoción' }}
    </h2>
    <form [formGroup]="promocionForm" (ngSubmit)="manejarSubmit()">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Código -->
        <div>
          <label for="codigo" class="block text-sm font-medium text-gray-700 mb-1">Código</label>
          <input type="text" id="codigo" formControlName="codigo" class="w-full rounded-md border border-gray-300 py-2 px-3 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-indigo-500">
          @if (promocionForm.get('codigo')?.invalid && promocionForm.get('codigo')?.touched) {
            <p class="text-red-500 text-xs mt-1">El código es requerido.</p>
          }
        </div>
        <!-- Descuento (%) -->
        <div>
          <label for="descuento" class="block text-sm font-medium text-gray-700 mb-1">Descuento (%)</label>
          <input type="number" id="descuento" formControlName="descuento" step="0.01" min="0.01" max="100" class="w-full rounded-md border border-gray-300 py-2 px-3 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-indigo-500">
           @if (promocionForm.get('descuento')?.invalid && promocionForm.get('descuento')?.touched) {
            <p class="text-red-500 text-xs mt-1">
              @if (promocionForm.get('descuento')?.errors?.['required']) { <span>Requerido.</span> }
              @if (promocionForm.get('descuento')?.errors?.['min'] || promocionForm.get('descuento')?.errors?.['max']) { <span>Debe estar entre 0.01 y 100.</span> }
            </p>
          }
        </div>
        <!-- Descripción -->
        <div class="md:col-span-2">
          <label for="descripcion" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
          <input type="text" id="descripcion" formControlName="descripcion" class="w-full rounded-md border border-gray-300 py-2 px-3 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-indigo-500">
           @if (promocionForm.get('descripcion')?.invalid && promocionForm.get('descripcion')?.touched) {
            <p class="text-red-500 text-xs mt-1">La descripción es requerida.</p>
          }
        </div>
        <!-- Fecha Inicio -->
        <div>
          <label for="fechaInicio" class="block text-sm font-medium text-gray-700 mb-1">Fecha Inicio</label>
          <input type="datetime-local" id="fechaInicio" formControlName="fechaInicio" class="w-full rounded-md border border-gray-300 py-2 px-3 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-indigo-500">
           @if (promocionForm.get('fechaInicio')?.invalid && promocionForm.get('fechaInicio')?.touched) {
            <p class="text-red-500 text-xs mt-1">Fecha de inicio requerida.</p>
          }
        </div>
        <!-- Fecha Fin -->
        <div>
          <label for="fechaFin" class="block text-sm font-medium text-gray-700 mb-1">Fecha Fin</label>
          <input type="datetime-local" id="fechaFin" formControlName="fechaFin" class="w-full rounded-md border border-gray-300 py-2 px-3 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-indigo-500">
           @if (promocionForm.get('fechaFin')?.invalid && promocionForm.get('fechaFin')?.touched) {
            <p class="text-red-500 text-xs mt-1">Fecha de fin requerida.</p>
          }
        </div>
        <!-- Activa -->
        <div class="md:col-span-2 flex items-center">
           <input id="activa" type="checkbox" formControlName="activa" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
           <label for="activa" class="ml-2 block text-sm text-gray-900">Promoción Activa</label>
        </div>
      </div>

       <!-- Error del Formulario -->
      @if(formError()) {
         <p class="text-red-600 text-sm mt-3 mb-3">{{ formError() }}</p>
      }

      <!-- Botones -->
      <div class="flex items-center space-x-3 mt-5 pt-4 border-t">
        <button type="submit" [disabled]="promocionForm.invalid || isLoading()"
                class="justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:bg-gray-400">
          @if(isLoading()){ <span>Guardando...</span> }
          @else { <span>{{ editMode() ? 'Actualizar Promoción' : 'Crear Promoción' }}</span> }
        </button>
        @if(editMode()) {
          <button type="button" (click)="resetForm()"
                  class="rounded-md border border-gray-300 bg-white py-2 px-4 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
            Cancelar Edición
          </button>
        }
      </div>
    </form>
  </div>

  <!-- Tabla de Promociones Existentes -->
  <h2 class="text-2xl font-semibold mb-4 text-gray-700">Promociones Existentes</h2>

  @if (isLoading() && promociones().length === 0) {
    <div class="text-center p-10"><p class="text-gray-600 animate-pulse">Cargando...</p></div>
  }
  @if (error() && !isLoading()) {
    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-md shadow" role="alert">
      <p class="font-bold">Error</p>
      <p>{{ error() }}</p>
    </div>
  }

  @if (!isLoading() && promociones().length === 0 && !error()) {
    <p class="text-center text-gray-500 py-10">No hay promociones creadas.</p>
  }

  @if (promociones().length > 0) {
    <div class="overflow-x-auto bg-white rounded-lg shadow">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Código</th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descuento (%)</th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Inicio</th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fin</th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          @for (promo of promociones(); track trackById($index, promo)) {
            <tr class="hover:bg-gray-50" [class.opacity-50]="!promo.activa">
              <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">{{ promo.codigo }}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600 max-w-xs truncate" title="{{promo.descripcion}}">{{ promo.descripcion }}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800">{{ promo.descuento }}%</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{{ promo.fechaInicio | date:'dd/MM/yy HH:mm' }}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-600">{{ promo.fechaFin | date:'dd/MM/yy HH:mm' }}</td>
              <td class="px-4 py-3 whitespace-nowrap text-sm">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                      [ngClass]="promo.activa ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                  {{ promo.activa ? 'Activa' : 'Inactiva' }}
                </span>
              </td>
              <td class="px-4 py-3 whitespace-nowrap text-sm font-medium space-x-2">
                <button (click)="onEdit(promo)" class="text-indigo-600 hover:text-indigo-900">Editar</button>
                @if(promo.activa){
                  <button (click)="onDeactivate(promo.idPromocion, promo.codigo)" class="text-red-600 hover:text-red-900">Desactivar</button>
                }
                <!-- Opcional: Botón para reactivar si quieres -->
                <!-- @if(!promo.activa){
                   <button (click)="onActivate(promo.idPromocion)" class="text-green-600 hover:text-green-900">Activar</button>
                } -->
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

</div>

